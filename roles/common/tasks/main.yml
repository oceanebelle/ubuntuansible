---
- name: Check if sudoers don't require password
  lineinfile: 
    path: /etc/sudoers
    state: present
    regexp: '^%sudo'
    line: '%sudo ALL=(ALL) NOPASSWD: ALL'
    validate: 'visudo -cf %s'
  become: yes
  register: cansudo

- name: Apt update
  when: cansudo is not changed
  apt: 
    name: "*"
    state: latest
  become: yes
  notify: 
    - upgrade apt
    - clean apt
    - remove apt 
    
- meta: flush_handlers  

- name: Install packages
  when: cansudo is not changed
  apt:
    pkg:
    - vim
    - curl
    - wget
    - keepassxc
    - git
    - thrift-compiler
    state: present
  become: yes
  

- name: Check if ssh exists
  stat:
    path: ~/.ssh
  notify:
    - add ssh directory
    - add ssh authorized_keys
    - add ssh config
  register: ssh_details 
  changed_when:
    - ssh_details.stat.exists == False 

- debug: 
    msg: The file {{ ssh_details.stat.path  }} exists is {{ ssh_details.stat.exists  }}

- meta: flush_handlers      


- name: setup git block
  blockinfile: 
    path: "{{ profile_path }}"
    state: present
    marker: "# {mark} Ansible Managed git prompt"
    block: "{{ lookup('template', 'gitprompt.j2') }}"


- name: Add aliases to profile
  blockinfile:  
    path: "{{ profile_path }}"
    state: present
    marker: "# {mark} Ansible Managed aliases"    
    block: "{{ lookup('template', 'aliases.j2') }}"
